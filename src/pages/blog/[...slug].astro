---
import { getEntry } from 'astro:content';

import Layout from '~/layouts/main-layout.astro';
import { getViewsForSlug } from '~/lib/xata';
import { cn, formatDate } from '~/lib/utils';

const { slug } = Astro.params as { slug: string };

if (!slug) throw new Error('Slug is required');

const entry = await getEntry('posts', slug);

if (!entry) return Astro.redirect('/404');

const { title, publishedAt } = entry.data;
const { Content, headings } = await entry.render();
const views = await getViewsForSlug(entry.slug);
---

<Layout>
    <div
        id="progress-bar"
        class="fixed inset-x-0 top-0 h-1 origin-[0%] scale-x-0 transform bg-neutral-200"
    >
    </div>

    <h1 class="text-2xl font-semibold tracking-tighter">
        {title}
    </h1>

    <div class="mb-8 mt-2 flex items-center justify-between text-sm text-neutral-400">
        <p class="text-sm">{formatDate(publishedAt)}</p>

        <p class="flex items-center gap-1 text-sm text-neutral-400">
            <span
                hx-get="/partials/views-counter"
                hx-trigger="load"
                hx-swap="outterHTML"
                hx-vals={JSON.stringify({ slug: entry.slug, track: true })}
            >
                <span class="htmx-indicator animate-pulse">{views}</span>
            </span>
             views
        </p>
    </div>

    <!-- TOC -->
    <h2 class="text-lg font-semibold capitalize tracking-tighter">table of contents</h2>
    <ul class="mb-6">
        {
            headings.map(({ depth, slug, text }) => (
                <li
                    class={cn({
                        'ml-0': depth === 2,
                        'ml-4': depth === 3,
                        'ml-8': depth === 4
                    })}
                >
                    <a
                        href={`#${slug}`}
                        class="py-1 font-light text-neutral-400 transition duration-200 hover:text-white"
                    >
                        {text}
                    </a>
                </li>
            ))
        }
    </ul>

    <article class="prose prose-invert">
        <Content />
    </article>

    <hr class="my-8 border-neutral-500/50" />
</Layout>

<script>
    import { animate, scroll } from 'motion';

    scroll(animate('#progress-bar', { scale: [0, 1] }));
</script>
